---
# Install system dependencies

- name: Install required system packages
  ansible.builtin.apt:
    name:
      - tar
      - gzip
      - gnupg
      - git
      - unzip
    state: present
    update_cache: true
  become: true

- name: Install rsync (for rsync offsite sync)
  ansible.builtin.apt:
    name: rsync
    state: present
  become: true
  when: pg_backup_offsite_type == 'rsync'

- name: Install PostgreSQL client tools
  ansible.builtin.apt:
    name: "postgresql-client-{{ pg_backup_postgresql_version }}"
    state: present
  become: true
  when: pg_backup_install_postgresql_client | bool

- name: Check if Bun is installed
  ansible.builtin.command: which bun
  register: bun_check
  changed_when: false
  failed_when: false

- name: Install Bun runtime
  when:
    - pg_backup_install_bun | bool
    - bun_check.rc != 0
  block:
    - name: Download Bun installer
      ansible.builtin.get_url:
        url: https://bun.sh/install
        dest: /tmp/bun-install.sh
        mode: '0755'

    - name: Install Bun
      ansible.builtin.shell: |
        BUN_INSTALL=/usr/local /tmp/bun-install.sh
      args:
        creates: /usr/local/bin/bun
      become: true

    - name: Clean up Bun installer
      ansible.builtin.file:
        path: /tmp/bun-install.sh
        state: absent
