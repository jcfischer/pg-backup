---
# Verify pg-backup installation

- name: Verify pg-backup binary is executable
  ansible.builtin.command:
    cmd: "{{ pg_backup_bin_path }} --version"
  register: pg_backup_version_check
  changed_when: false
  become: true

- name: Display pg-backup version
  ansible.builtin.debug:
    msg: "pg-backup installed: {{ pg_backup_version_check.stdout }}"

- name: Verify timer is active
  ansible.builtin.command:
    cmd: systemctl is-active pg-backup.timer
  register: timer_status
  changed_when: false
  failed_when: timer_status.stdout != 'active'
  become: true

- name: Get next scheduled backup time
  ansible.builtin.command:
    cmd: systemctl list-timers pg-backup.timer --no-pager
  register: timer_schedule
  changed_when: false
  become: true

- name: Display backup schedule
  ansible.builtin.debug:
    msg: "{{ timer_schedule.stdout_lines }}"

- name: Test backup configuration (dry run)
  ansible.builtin.shell: |
    sudo -u {{ pg_backup_user }} bash -c 'source /etc/pg-backup/pg-backup.env && {{ pg_backup_bin_path }} status --backup-dir {{ pg_backup_dir }}' 2>&1 || true
  register: backup_test
  changed_when: false
  become: true

- name: Display backup status
  ansible.builtin.debug:
    msg: "{{ backup_test.stdout_lines }}"
